# üöÄ GUIA COMPLETO: DEPLOY PARA PRODU√á√ÉO VPS

## ‚ö†Ô∏è IMPORTANTE
Este guia ir√° atualizar sua aplica√ß√£o em produ√ß√£o SEM PERDER NENHUM DADO.
As migra√ß√µes foram preparadas para serem **IDEMPOTENTES** (podem ser executadas m√∫ltiplas vezes sem problemas).

---

## üì¶ PARTE 1: PREPARAR E ENVIAR C√ìDIGO (WINDOWS)

### 1Ô∏è‚É£ Verificar o que foi modificado

Abra o **PowerShell** na pasta do projeto e execute:

```powershell
cd "C:\Users\Luiz Marcelo\Desktop\PLANILHA DE PENDENCIAS"
git status
```

**O que voc√™ deve ver:**
- Arquivos modificados (modified)
- Arquivos novos (untracked)

---

### 2Ô∏è‚É£ Adicionar todos os arquivos ao Git

```powershell
# Adicionar TODOS os arquivos modificados e novos
git add .

# Verificar o que ser√° commitado
git status
```

**Voc√™ deve ver:**
- ‚úÖ `app.py` (modificado)
- ‚úÖ `requirements.txt` (modificado)
- ‚úÖ `templates/base.html` (modificado)
- ‚úÖ `templates/supervisor_pendencias.html` (modificado)
- ‚úÖ `templates/editar_pendencia.html` (modificado)
- ‚úÖ `templates/nova_pendencia.html` (modificado)
- ‚úÖ `templates/importar_planilha.html` (modificado)
- ‚úÖ `static/up380.css` (modificado)
- ‚úÖ `migracao_producao_completa.py` (novo)
- ‚úÖ `migracao_consolidar_documentos.py` (novo)
- ‚úÖ `modelo_*.xlsx` (novos - 9 arquivos)
- ‚úÖ Arquivos de documenta√ß√£o `.md` (novos)

---

### 3Ô∏è‚É£ Fazer o commit

```powershell
git commit -m "feat: Adiciona sistema de segmentos, ajustes frontend e novas planilhas modelo

- Implementa sistema completo de segmentos e vincula√ß√£o de empresas
- Adiciona planilhas modelo individuais para cada tipo de pend√™ncia
- Corrige campo Banco para sempre aparecer nos formul√°rios
- Melhora parsing de valores monet√°rios em formato brasileiro
- Ajusta modal do supervisor para textos longos
- Inclui migra√ß√µes de banco de dados seguras
- Adiciona consolida√ß√£o de tipos de documentos antigos"
```

---

### 4Ô∏è‚É£ Enviar para o GitHub

```powershell
git push origin main
```

**Se pedir usu√°rio e senha:**
- Usu√°rio: seu email do GitHub
- Senha: seu **Personal Access Token** (n√£o √© a senha normal!)

---

## üîß PARTE 2: FAZER BACKUP DA PRODU√á√ÉO (VPS)

### 1Ô∏è‚É£ Conectar √† VPS via SSH

```powershell
ssh seu_usuario@seu_ip_da_vps
```

**Exemplo:**
```powershell
ssh root@123.456.789.0
```

---

### 2Ô∏è‚É£ Fazer backup do banco de dados ATUAL

```bash
# Ir para a pasta do projeto
cd ~/sistema_pendencia

# Criar pasta de backups se n√£o existir
mkdir -p backups

# Fazer backup com data/hora
docker exec sistema_pendencia-web-1 python backup_database.py

# OU manualmente:
docker cp sistema_pendencia-web-1:/app/instance/pendencias.db ./backups/pendencias_backup_$(date +%Y%m%d_%H%M%S).db

# Verificar se o backup foi criado
ls -lh backups/
```

**‚úÖ IMPORTANTE:** Guarde este backup! Se algo der errado, voc√™ pode restaurar.

---

## üîÑ PARTE 3: ATUALIZAR O C√ìDIGO NA VPS

### 1Ô∏è‚É£ Ir para a pasta do projeto

```bash
cd ~/sistema_pendencia
```

---

### 2Ô∏è‚É£ Verificar a branch atual

```bash
git branch
git status
```

---

### 3Ô∏è‚É£ Puxar as atualiza√ß√µes do GitHub

```bash
# Buscar as atualiza√ß√µes
git fetch origin

# Atualizar o c√≥digo
git pull origin main
```

**Se aparecer conflitos:**
```bash
# Ver quais arquivos t√™m conflito
git status

# Se quiser usar SEMPRE a vers√£o nova do GitHub:
git reset --hard origin/main
```

---

### 4Ô∏è‚É£ Verificar se os arquivos foram atualizados

```bash
# Verificar se os arquivos de migra√ß√£o est√£o presentes
ls -lh migra*.py

# Verificar se as planilhas foram criadas
ls -lh modelo_*.xlsx

# Verificar a data de modifica√ß√£o do app.py
ls -lh app.py
```

---

## üóÑÔ∏è PARTE 4: EXECUTAR AS MIGRA√á√ïES (SEM PERDER DADOS!)

### 1Ô∏è‚É£ Parar os containers

```bash
docker-compose down
```

---

### 2Ô∏è‚É£ Executar a migra√ß√£o PRINCIPAL (Segmentos + Campos)

```bash
# Executar a migra√ß√£o dentro do container
docker-compose run --rm web python migracao_producao_completa.py
```

**O que esta migra√ß√£o faz:**
- ‚úÖ Cria tabela `segmento` se n√£o existir
- ‚úÖ Adiciona coluna `segmento_id` na tabela `empresa` se n√£o existir
- ‚úÖ Cria segmentos padr√£o (AGRO, CONSTRU√á√ÉO, EDUCA√á√ÉO, etc.)
- ‚úÖ Vincula empresas existentes aos segmentos automaticamente
- ‚úÖ Adiciona campo `data` na tabela `pendencia` se n√£o existir
- ‚úÖ Preenche datas faltantes com `data_abertura`
- ‚úÖ **N√ÉO PERDE NENHUM DADO EXISTENTE**

**Sa√≠da esperada:**
```
=== INICIANDO MIGRA√á√ÉO PARA PRODU√á√ÉO ===
[OK] Tabela 'segmento' criada com sucesso
[OK] Coluna 'segmento_id' adicionada √† tabela 'empresa'
[OK] 6 segmentos criados
[OK] 15 empresas vinculadas aos segmentos
[OK] Coluna 'data' adicionada √† tabela 'pendencia'
[OK] 120 pend√™ncias atualizadas com datas
=== MIGRA√á√ÉO CONCLU√çDA COM SUCESSO ===
```

---

### 3Ô∏è‚É£ Executar a migra√ß√£o de DOCUMENTOS (Consolida√ß√£o)

```bash
# Executar a segunda migra√ß√£o
docker-compose run --rm web python migracao_consolidar_documentos.py
```

**O que esta migra√ß√£o faz:**
- ‚úÖ Converte pend√™ncias antigas:
  - "NOTA FISCAL N√ÉO ANEXADA" ‚Üí "DOCUMENTO N√ÉO ANEXADO"
  - "NOTA FISCAL N√ÉO IDENTIFICADA" ‚Üí "DOCUMENTO N√ÉO ANEXADO"
- ‚úÖ Registra logs de todas as altera√ß√µes
- ‚úÖ Mant√©m hist√≥rico completo
- ‚úÖ **N√ÉO APAGA NADA, APENAS RENOMEIA**

**Sa√≠da esperada:**
```
=== MIGRA√á√ÉO: CONSOLIDAR TIPOS DE DOCUMENTOS ===
[INFO] 45 pend√™ncias de 'NOTA FISCAL N√ÉO ANEXADA' encontradas
[INFO] 23 pend√™ncias de 'NOTA FISCAL N√ÉO IDENTIFICADA' encontradas
[OK] 68 pend√™ncias migradas para 'DOCUMENTO N√ÉO ANEXADO'
[OK] 68 logs criados
=== MIGRA√á√ÉO CONCLU√çDA COM SUCESSO ===
```

---

## üöÄ PARTE 5: REINICIAR A APLICA√á√ÉO

### 1Ô∏è‚É£ Subir os containers novamente

```bash
# Subir os containers em modo detached (background)
docker-compose up -d --build
```

**O que acontece:**
- Reconstr√≥i a imagem Docker com o c√≥digo novo
- Instala depend√™ncias atualizadas do `requirements.txt`
- Inicia a aplica√ß√£o

---

### 2Ô∏è‚É£ Verificar se os containers est√£o rodando

```bash
docker-compose ps
```

**Sa√≠da esperada:**
```
NAME                       STATUS              PORTS
sistema_pendencia-web-1    Up 10 seconds      0.0.0.0:5000->5000/tcp
```

---

### 3Ô∏è‚É£ Verificar os logs da aplica√ß√£o

```bash
# Ver os logs em tempo real
docker-compose logs -f web

# OU apenas as √∫ltimas 50 linhas
docker-compose logs --tail=50 web
```

**Procure por:**
- ‚úÖ `Running on http://0.0.0.0:5000`
- ‚úÖ Sem erros de importa√ß√£o
- ‚úÖ Sem erros de banco de dados

**Para sair dos logs:** Pressione `Ctrl + C`

---

## ‚úÖ PARTE 6: VALIDAR A APLICA√á√ÉO

### 1Ô∏è‚É£ Testar o acesso via navegador

Abra seu navegador e acesse:
```
http://seu_ip_da_vps:5000
```

**OU se tiver dom√≠nio configurado:**
```
https://seu-dominio.com.br
```

---

### 2Ô∏è‚É£ Fazer login e verificar

1. ‚úÖ Fa√ßa login com seu usu√°rio
2. ‚úÖ V√° em **"Segmentos"** no menu
3. ‚úÖ Verifique se os segmentos aparecem (AGRO, CONSTRU√á√ÉO, etc.)
4. ‚úÖ Clique em um segmento e veja se as empresas aparecem
5. ‚úÖ V√° em **"Empresas"** no menu
6. ‚úÖ Clique em **"Nova Pend√™ncia"**
7. ‚úÖ Verifique se o campo **"Banco"** aparece
8. ‚úÖ V√° em **"Importar Planilha"**
9. ‚úÖ Baixe uma planilha modelo e veja se baixa corretamente
10. ‚úÖ V√° em **"Supervisor"** (se for supervisor/adm)
11. ‚úÖ Abra uma pend√™ncia e veja se o modal aparece correto

---

### 3Ô∏è‚É£ Verificar pend√™ncias existentes

```bash
# Conectar no container
docker exec -it sistema_pendencia-web-1 bash

# Abrir o Python
python

# Verificar os dados
from app import db, Pendencia, Empresa, Segmento

# Ver quantas pend√™ncias existem
print(f"Total de pend√™ncias: {Pendencia.query.count()}")

# Ver quantos segmentos existem
print(f"Total de segmentos: {Segmento.query.count()}")

# Ver quantas empresas existem
print(f"Total de empresas: {Empresa.query.count()}")

# Ver empresas por segmento
for seg in Segmento.query.all():
    print(f"{seg.nome}: {len(seg.empresas)} empresas")

# Sair
exit()
exit
```

---

## üÜò PARTE 7: SE ALGO DER ERRADO

### ‚ùå Caso 1: Erro durante a migra√ß√£o

```bash
# Parar containers
docker-compose down

# Restaurar o backup
docker cp ./backups/pendencias_backup_XXXXXXXX_XXXXXX.db sistema_pendencia-web-1:/app/instance/pendencias.db

# Subir novamente
docker-compose up -d

# Ver os logs do erro
docker-compose logs --tail=100 web
```

---

### ‚ùå Caso 2: Aplica√ß√£o n√£o inicia

```bash
# Ver os logs completos
docker-compose logs web

# Ver erros do Python
docker-compose logs web | grep -i error

# Verificar se o banco existe
docker exec -it sistema_pendencia-web-1 ls -lh instance/

# Reiniciar completamente
docker-compose down
docker-compose up -d --build
```

---

### ‚ùå Caso 3: P√°gina em branco ou erro 500

```bash
# Ver logs em tempo real
docker-compose logs -f web

# Verificar permiss√µes
docker exec -it sistema_pendencia-web-1 bash
ls -lh instance/
chmod 644 instance/pendencias.db
exit

# Reiniciar
docker-compose restart web
```

---

## üìä PARTE 8: COMANDOS √öTEIS

### Verificar espa√ßo em disco
```bash
df -h
```

### Ver uso de mem√≥ria
```bash
free -h
```

### Ver containers rodando
```bash
docker ps
```

### Ver imagens Docker
```bash
docker images
```

### Limpar containers antigos
```bash
docker system prune -a
```

### Ver logs espec√≠ficos
```bash
# Logs do Nginx (se usar)
docker-compose logs nginx

# Logs do banco (se usar PostgreSQL)
docker-compose logs db
```

---

## üéØ RESUMO DOS COMANDOS

### NO WINDOWS (PowerShell):
```powershell
cd "C:\Users\Luiz Marcelo\Desktop\PLANILHA DE PENDENCIAS"
git add .
git commit -m "Atualiza√ß√£o com segmentos e melhorias"
git push origin main
```

### NA VPS (SSH):
```bash
# Backup
cd ~/sistema_pendencia
docker cp sistema_pendencia-web-1:/app/instance/pendencias.db ./backups/pendencias_backup_$(date +%Y%m%d_%H%M%S).db

# Atualizar c√≥digo
git pull origin main

# Parar
docker-compose down

# Migrar
docker-compose run --rm web python migracao_producao_completa.py
docker-compose run --rm web python migracao_consolidar_documentos.py

# Subir
docker-compose up -d --build

# Verificar
docker-compose logs -f web
```

---

## ‚úÖ CHECKLIST FINAL

Antes de considerar o deploy conclu√≠do, verifique:

- [ ] Backup do banco foi feito
- [ ] C√≥digo foi puxado do Git
- [ ] Migra√ß√£o 1 executada sem erros
- [ ] Migra√ß√£o 2 executada sem erros
- [ ] Containers est√£o rodando (`docker-compose ps`)
- [ ] Aplica√ß√£o abre no navegador
- [ ] Login funciona
- [ ] Menu "Segmentos" aparece e funciona
- [ ] Empresas est√£o vinculadas aos segmentos
- [ ] Campo "Banco" aparece nos formul√°rios
- [ ] Planilhas modelo podem ser baixadas
- [ ] Modal do supervisor funciona corretamente
- [ ] Pend√™ncias antigas ainda aparecem
- [ ] N√£o h√° erros nos logs

---

## üìû SUPORTE

Se encontrar qualquer erro:

1. **Anote a mensagem de erro COMPLETA**
2. **Copie os logs:** `docker-compose logs web > erro.log`
3. **Tire um print da tela**
4. **Me envie para an√°lise**

---

## üéâ PRONTO!

Seu sistema est√° atualizado em produ√ß√£o com:
- ‚úÖ Sistema de Segmentos
- ‚úÖ Planilhas modelo individuais
- ‚úÖ Campo Banco corrigido
- ‚úÖ Modal do supervisor ajustado
- ‚úÖ Consolida√ß√£o de tipos de documentos
- ‚úÖ Todos os dados preservados

**Bom trabalho! üöÄ**


