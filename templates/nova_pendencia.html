{% extends "base.html" %}

{% block title %}Nova Pendência - Sistema de Pendências{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title mb-0">Nova Pendência</h2>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.nova_pendencia') }}" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <div class="mb-3">
                        <label for="empresa" class="form-label">Empresa</label>
                        <select class="form-select" id="empresa" name="empresa" required>
                            <option value="" disabled {{ 'selected' if not preselect_empresa else '' }}>Selecione a
                                empresa</option>
                            {% for emp in empresas %}
                            <option value="{{ emp }}" {{ 'selected' if emp==preselect_empresa else '' }}>{{ emp }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="tipo_pendencia" class="form-label">Tipo de Pendência</label>
                        <select class="form-select" id="tipo_pendencia" name="tipo_pendencia" required>
                            {% for tipo in tipos_pendencia %}
                            <option value="{{ tipo }}">{{ tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Tipo de Lançamento (Crédito/Débito) -->
                    <div class="mb-3" id="grp_tipo_credito_debito" style="display:none;">
                        <label for="tipo_credito_debito" class="form-label">
                            Tipo de Lançamento <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="tipo_credito_debito" name="tipo_credito_debito">
                            <option value="">Selecione...</option>
                            <option value="CREDITO">Crédito</option>
                            <option value="DEBITO">Débito</option>
                        </select>
                    </div>

                    <!-- Banco (sempre visível) -->
                    <div class="mb-3" id="grp_banco">
                        <label for="banco" class="form-label">Banco</label>
                        <input type="text" class="form-control" id="banco" name="banco"
                            placeholder="Ex: Banco do Brasil, Itaú, Bradesco...">
                    </div>

                    <!-- Data da Pendência -->
                    <div class="mb-3" id="grp_data">
                        <label for="data" class="form-label" id="lbl_data">Data da Pendência</label>
                        <input type="date" class="form-control" id="data" name="data">
                        <div class="form-text">Data do lançamento/extrato. Para "Nota Fiscal Não Identificada", deixe em
                            branco.</div>
                    </div>

                    <!-- Data Competência -->
                    <div class="mb-3" id="grp_data_competencia" style="display:none;">
                        <label for="data_competencia" class="form-label">Data Competência</label>
                        <input type="date" class="form-control" id="data_competencia" name="data_competencia">
                    </div>

                    <!-- Data Baixa -->
                    <div class="mb-3" id="grp_data_baixa" style="display:none;">
                        <label for="data_baixa" class="form-label">Data da Baixa</label>
                        <input type="date" class="form-control" id="data_baixa" name="data_baixa">
                    </div>

                    <!-- Fornecedor/Cliente -->
                    <div class="mb-3" id="grp_fornecedor">
                        <label for="fornecedor_cliente" class="form-label">Fornecedor/Cliente</label>
                        <input type="text" class="form-control" id="fornecedor_cliente" name="fornecedor_cliente">
                    </div>

                    <!-- Valor -->
                    <div class="mb-3" id="grp_valor">
                        <label for="valor" class="form-label">Valor</label>
                        <input type="text" class="form-control" id="valor" name="valor" placeholder="R$ 0,00"
                            oninput="formatarMoeda(this)">
                    </div>

                    <!-- Código do Lançamento -->
                    <div class="mb-3" id="grp_codigo">
                        <label for="codigo_lancamento" class="form-label">Código do Lançamento</label>
                        <input type="text" class="form-control" id="codigo_lancamento" name="codigo_lancamento">
                    </div>

                    <!-- Natureza do Sistema -->
                    <div class="mb-3" id="grp_natureza_sistema" style="display:none;">
                        <label for="natureza_sistema" class="form-label">Natureza Atual no Sistema</label>
                        <input type="text" class="form-control" id="natureza_sistema" name="natureza_sistema"
                            placeholder="Ex.: Serviços - 3.01.02">
                        <div class="form-text">Natureza que está atualmente no ERP</div>
                    </div>

                    <!-- Observação -->
                    <div class="mb-3" id="grp_obs">
                        <label for="observacao" class="form-label">Observação</label>
                        <textarea class="form-control" id="observacao" name="observacao" rows="2"
                            placeholder="DO QUE SE TRATA?"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="email_cliente" class="form-label">E-mail do Cliente (opcional)</label>
                        <input type="email" class="form-control" id="email_cliente" name="email_cliente">
                    </div>
                    <div class="mb-3" id="nota_fiscal_upload" style="display:none;">
                        <label for="nota_fiscal_arquivo" class="form-label">Anexar Nota Fiscal (PDF, JPG, PNG)</label>
                        <input type="file" class="form-control" id="nota_fiscal_arquivo" name="nota_fiscal_arquivo"
                            accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Salvar Pendência
                        </button>
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    // Configuração de campos por tipo de pendência
    const tipoConfig = {
        "Cartão de Crédito Não Identificado": {
            show: ["grp_data", "grp_fornecedor", "grp_valor", "grp_obs"],
            hide: ["grp_data_competencia", "grp_data_baixa", "grp_codigo", "grp_natureza_sistema", "grp_tipo_credito_debito"],
            required: ["banco", "data", "valor"],
            label_data: null
        },
        "Pagamento Não Identificado": {
            show: ["grp_data", "grp_fornecedor", "grp_valor", "grp_obs"],
            hide: ["grp_data_competencia", "grp_data_baixa", "grp_codigo", "grp_natureza_sistema", "grp_tipo_credito_debito"],
            required: ["banco", "data", "valor"],
            label_data: null
        },
        "Recebimento Não Identificado": {
            show: ["grp_data", "grp_fornecedor", "grp_valor", "grp_obs"],
            hide: ["grp_data_competencia", "grp_data_baixa", "grp_codigo", "grp_natureza_sistema", "grp_tipo_credito_debito"],
            required: ["banco", "data", "valor"],
            label_data: null
        },
        "Documento Não Anexado": {
            show: ["grp_fornecedor", "grp_valor", "grp_obs", "grp_data", "grp_banco"],
            hide: ["grp_data_competencia", "grp_data_baixa", "grp_codigo", "grp_natureza_sistema", "grp_tipo_credito_debito"],
            required: ["fornecedor_cliente", "valor", "data"],
            label_data: null
        },
        "Lançamento Não Encontrado em Extrato": {
            show: ["grp_data", "grp_fornecedor", "grp_valor", "grp_codigo", "grp_obs", "grp_tipo_credito_debito"],
            hide: ["grp_data_competencia", "grp_data_baixa", "grp_natureza_sistema"],
            required: ["banco", "data", "fornecedor_cliente", "valor", "tipo_credito_debito"],
            label_data: null
        },
        "Lançamento Não Encontrado em Sistema": {
            show: ["grp_fornecedor", "grp_valor", "grp_data", "grp_obs", "grp_tipo_credito_debito", "grp_banco"],
            hide: ["grp_data_competencia", "grp_data_baixa", "grp_natureza_sistema", "grp_codigo"],
            required: ["fornecedor_cliente", "valor", "data", "tipo_credito_debito"],
            label_data: null
        },
        "Natureza Errada": {
            show: ["grp_fornecedor", "grp_valor", "grp_codigo", "grp_obs", "grp_data", "grp_natureza_sistema", "grp_banco"],
            hide: ["grp_data_competencia", "grp_data_baixa", "grp_tipo_credito_debito"],
            required: ["fornecedor_cliente", "valor", "codigo_lancamento", "data"],
            label_data: "Data do Lançamento ou Baixa"
        },
        "Competência Errada": {
            show: ["grp_fornecedor", "grp_valor", "grp_codigo", "grp_obs", "grp_data_competencia", "grp_banco"],
            hide: ["grp_data_baixa", "grp_data", "grp_natureza_sistema", "grp_tipo_credito_debito"],
            required: ["fornecedor_cliente", "valor", "codigo_lancamento", "data_competencia"],
            label_data: null
        },
        "Data da Baixa Errada": {
            show: ["grp_fornecedor", "grp_valor", "grp_codigo", "grp_obs", "grp_data_baixa"],
            hide: ["grp_data", "grp_data_competencia", "grp_natureza_sistema"],
            required: ["banco", "data_baixa", "fornecedor_cliente", "valor", "codigo_lancamento"],
            label_data: null
        }
    };

    function applyTipoConfig(tipo) {
        const config = tipoConfig[tipo] || { show: [], hide: [], required: [] };

        // Mostrar campos
        config.show.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'block';
            }
        });

        // Ocultar campos
        config.hide.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
            }
        });

        // Configurar campos obrigatórios
        const allFields = ['fornecedor_cliente', 'valor', 'codigo_lancamento', 'data', 'data_competencia', 'data_baixa', 'banco'];
        allFields.forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                element.required = config.required.includes(field);
            }
        });

        // Atualizar rótulo da data
        const dataLabel = document.getElementById('lbl_data');
        if (dataLabel && config.label_data) {
            dataLabel.textContent = config.label_data;
        }

        // Habilitar campo data
        const dataField = document.getElementById('data');
        if (dataField) {
            dataField.disabled = false;
        }

        // Mostrar/ocultar upload de nota fiscal
        const uploadDiv = document.getElementById('nota_fiscal_upload');
        if (uploadDiv) {
            uploadDiv.style.display = (tipo === 'Nota Fiscal Não Anexada') ? 'block' : 'none';
        }
    }

    // Event listener para mudança de tipo
    document.getElementById('tipo_pendencia').addEventListener('change', function () {
        console.log('Tipo selecionado:', this.value);
        applyTipoConfig(this.value);
    });

    // Aplicar configuração inicial
    document.addEventListener('DOMContentLoaded', function () {
        const tipoSelect = document.getElementById('tipo_pendencia');
        if (tipoSelect && tipoSelect.value) {
            console.log('Tipo inicial:', tipoSelect.value);
            applyTipoConfig(tipoSelect.value);
        }
    });

    // Função para formatação de moeda BRL
    function formatarMoeda(input) {
        let valor = input.value.replace(/\D/g, '');
        if (!valor) {
            input.value = 'R$ 0,00';
            return;
        }
        let numero = parseInt(valor) / 100;
        input.value = numero.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2
        });
    }
</script>
{% endblock %}