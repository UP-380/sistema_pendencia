{% extends "base.html" %}

{% block title %}Painel Principal - UP380{% endblock %}

{% block content %}
<!-- Breadcrumb -->
{% if segmento_nome and segmento_id %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb" style="background: rgba(27, 54, 93, 0.05); padding: 0.75rem 1.5rem; border-radius: 0.8rem;">
        <li class="breadcrumb-item">
            <a href="{{ url_for('main.listar_segmentos') }}"
                style="color: #1976d2; text-decoration: none; font-weight: 600;">
                <i class="bi bi-grid-3x3-gap me-1"></i>
                Segmentos
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('main.empresas_por_segmento', id=segmento_id) }}"
                style="color: #1976d2; text-decoration: none; font-weight: 600;">
                {{ segmento_nome }}
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <strong>{{ empresa_filtro }}</strong>
        </li>
    </ol>
</nav>
{% else %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.pre_dashboard') }}">Empresas</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ empresa_filtro }}</li>
        <li class="breadcrumb-item active" aria-current="page">Painel de Pendências</li>
    </ol>
</nav>
{% endif %}

<div class="row mb-4">
    {% for tipo in tipos_pendencia %}
    <div class="col-lg-3 col-md-4 mb-3">
        <a href="{{ url_for('main.dashboard', empresa=empresa_filtro, tipo_pendencia=tipo) }}"
            style="text-decoration:none; color:inherit;">
            <div class="card-resumo card-hover">
                <span class="icon"><i class="bi bi-tag"></i></span>
                <div>
                    <div class="value">{{ pendencias_empresa | selectattr('tipo_pendencia', 'equalto', tipo) | list |
                        length }}</div>
                    <div class="label">{{ tipo }}</div>
                </div>
            </div>
        </a>
    </div>
    {% endfor %}
</div>

<style>
    .filtro-sticky {
        position: sticky;
        top: 80px;
        z-index: 100;
        background: #f5f6fa;
        padding-top: 1rem;
        padding-bottom: 0.5rem;
    }

    /* Ajustes para tabela de pendências - layout melhorado */
    .table-responsive {
        overflow-x: auto;
        overflow-y: visible;
        width: 100%;
        position: relative;
        -webkit-overflow-scrolling: touch;
    }

    @media (min-width: 1200px) {
        .table-responsive {
            overflow-x: visible;
        }
    }

    /* Garantir que o card contenha tudo */
    .card-body .table-responsive {
        position: relative;
        overflow: visible;
    }

    .card-body {
        overflow: visible;
        position: relative;
    }

    .table {
        font-size: 0.875rem;
        margin-bottom: 0;
        width: 100%;
        table-layout: fixed;
        border-collapse: separate;
        border-spacing: 0;
    }

    .card-body {
        padding: 1.5rem !important;
        position: relative;
        overflow: visible;
    }

    .card.mb-4 {
        margin-bottom: 2rem !important;
        overflow: visible;
    }

    .card {
        overflow: visible;
    }

    .table thead th {
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.75rem 0.6rem;
        white-space: nowrap;
        vertical-align: middle;
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        color: #222B45;
    }

    .table tbody td {
        padding: 0.7rem 0.6rem;
        vertical-align: middle;
        font-size: 0.875rem;
        line-height: 1.4;
    }

    /* Ajustar larguras das colunas - melhor distribuição */
    .table th:nth-child(1),
    .table td:nth-child(1) {
        width: 14%;
        white-space: nowrap;
        min-width: 180px;
    }

    .table th:nth-child(2),
    .table td:nth-child(2) {
        width: 7%;
    }

    .table th:nth-child(3),
    .table td:nth-child(3) {
        width: 9%;
    }

    /* Tabela Responsiva com Scroll */
    .table th,
    .table td {
        white-space: nowrap;
        /* Evita quebra de linha indesejada */
        vertical-align: middle;
    }

    /* Definir larguras mínimas para colunas críticas */
    .table th:nth-child(1),
    .table td:nth-child(1) {
        min-width: 120px;
    }

    /* Tipo */
    .table th:nth-child(2),
    .table td:nth-child(2) {
        min-width: 150px;
    }

    /* Fornecedor */
    .table th:nth-child(3),
    .table td:nth-child(3) {
        min-width: 100px;
    }

    /* Valor */
    .table th:nth-child(4),
    .table td:nth-child(4) {
        min-width: 100px;
    }

    /* Código */
    .table th:nth-child(5),
    .table td:nth-child(5) {
        min-width: 110px;
    }

    /* Data */
    .table th:nth-child(6),
    .table td:nth-child(6) {
        min-width: 200px;
    }

    /* Observação */
    .table th:nth-child(7),
    .table td:nth-child(7) {
        min-width: 130px;
    }

    /* Status */

    /* Coluna de ações fixa à direita em telas grandes? (Opcional, mas simples é melhor agora) */


    /* Truncar texto longo apenas em colunas específicas */
    .table td:nth-child(4),
    .table td:nth-child(6) {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 0;
    }

    .table td:has(.badge) {
        white-space: normal;
        overflow: visible;
    }

    /* Badges melhorados */
    .table .badge {
        font-size: 0.7rem;
        padding: 0.35rem 0.6rem;
        font-weight: 500;
        white-space: normal;
        line-height: 1.3;
        display: inline-block;
        max-width: 100%;
        word-wrap: break-word;
    }

    .table .badge i {
        font-size: 0.75rem;
        margin-right: 0.25rem;
    }

    /* Botões de ação melhorados - apenas ícones, dentro da célula */
    .table th:last-child {
        text-align: center;
        vertical-align: middle;
        width: 7%;
        min-width: 100px;
        max-width: 120px;
        padding: 0.75rem 0.5rem !important;
    }

    .table td:last-child {
        width: 7%;
        min-width: 100px;
        max-width: 120px;
        white-space: normal;
        vertical-align: middle;
        position: relative;
        padding: 0.7rem 0.5rem !important;
        text-align: center;
        overflow: visible;
    }

    /* Campo Anexo - mostrar apenas quando houver arquivo */
    .table th:nth-last-child(2) {
        text-align: center;
        vertical-align: middle;
    }

    .table td:nth-last-child(2) {
        text-align: center;
        vertical-align: middle;
        padding: 0.7rem 0.5rem !important;
    }

    .table td:nth-last-child(2):empty,
    .table td:nth-last-child(2):has(span.text-muted) {
        padding: 0.7rem 0.5rem !important;
    }

    .table td:nth-last-child(2) span.text-muted {
        display: none;
    }

    /* Botão Verificar - CENTRALIZADO */
    .acoes-cell {
        text-align: center !important;
        vertical-align: middle !important;
        padding: 0.7rem 0.5rem !important;
        width: 7% !important;
        min-width: 100px !important;
        max-width: 120px !important;
    }

    .acoes-cell .btn {
        font-size: 0.8rem !important;
        padding: 0.4rem 0.8rem !important;
        white-space: nowrap !important;
    }

    /* FORÇAR VISIBILIDADE E ALINHAMENTO */
    table tbody tr td.acoes-cell {
        text-align: center !important;
    }

    table tbody tr td.acoes-cell a,
    table tbody tr td.acoes-cell form {
        display: inline-block !important;
        margin: 0 0.15rem !important;
    }

    table tbody tr td.acoes-cell button,
    table tbody tr td.acoes-cell .btn {
        display: inline-flex !important;
    }

    /* Evitar que botões saiam do card */
    .card-body .table-responsive {
        position: relative;
        z-index: 1;
    }

    /* Garantir alinhamento vertical */
    .table tbody tr {
        position: relative;
    }

    .table tbody tr td {
        position: relative;
    }

    /* Ajustar botão de anexo */
    .table .btn-outline-primary {
        font-size: 0.75rem;
        padding: 0.35rem 0.5rem;
    }

    /* Tooltip para texto truncado */
    .table td:nth-child(4),
    .table td:nth-child(6) {
        position: relative;
    }

    .table td:nth-child(4):hover,
    .table td:nth-child(6):hover {
        overflow: visible;
        z-index: 10;
    }

    .table td:nth-child(4):hover::after,
    .table td:nth-child(6):hover::after {
        content: attr(title);
        position: absolute;
        left: 0;
        top: 100%;
        background-color: #333;
        color: white;
        padding: 0.5rem;
        border-radius: 0.25rem;
        white-space: normal;
        z-index: 1000;
        max-width: 300px;
        word-wrap: break-word;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Melhorar visualização geral */
    .card {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 0.5rem;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    /* Ajustar cards de resumo no topo */
    .card-resumo {
        padding: 1.25rem !important;
        min-height: 100px;
        transition: all 0.3s ease;
    }

    .card-resumo:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }

    .card-resumo .value {
        font-size: 1.75rem;
        font-weight: 700;
    }

    .card-resumo .label {
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }

    /* Melhorar espaçamento geral */
    .row.mb-4 {
        margin-bottom: 2rem !important;
    }

    /* Ajustar container principal */
    .container {
        max-width: 1400px;
    }

    @media (min-width: 1600px) {
        .container {
            max-width: 1600px;
        }
    }
</style>
</style>
<div class="filtro-sticky">
    <form method="get" class="row g-2 align-items-end mb-4">
        <input type="hidden" name="empresa" value="{{ empresa_filtro }}">
        <div class="col-auto">
            <label for="tipo_pendencia" class="form-label mb-0">Tipo de Pendência:</label>
            <select class="form-select" id="tipo_pendencia" name="tipo_pendencia" onchange="this.form.submit()">
                {% for tipo in tipos_pendencia %}
                <option value="{{ tipo }}" {% if tipo==tipo_filtro %}selected{% endif %}>{{ tipo }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('main.dashboard', empresa=empresa_filtro) }}" class="btn btn-secondary">Limpar</a>
        </div>
    </form>
</div>

<div class="mb-3">
    <form method="get" class="row g-2 align-items-end">
        <input type="hidden" name="empresa" value="{{ empresa_filtro }}">
        <input type="hidden" name="tipo_pendencia" value="{{ tipo_filtro }}">
        <div class="col-md-3">
            <input type="text" class="form-control" name="busca" placeholder="Buscar por fornecedor, valor, etc."
                value="{{ request.args.get('busca', '') }}">
        </div>
        <div class="col-md-1">
            <button type="submit" class="btn btn-primary">Pesquisar</button>
        </div>
    </form>
</div>

<!-- Tabelas de pendências em aberto -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Painel de Pendências</h1>
    {% if session['usuario_tipo'] == 'master' %}
    <a href="{{ url_for('main.importar_planilha') }}" class="btn btn-secondary">
        <i class="bi bi-upload"></i> Importar Planilha
    </a>
    {% endif %}
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        {% for coluna in colunas_tipo %}
                        {% if coluna != 'modificado_por' %}
                        <th>{{ todas_colunas[coluna] }}</th>
                        {% endif %}
                        {% endfor %}
                        <th>Modificado por</th>
                        <th>Anexo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pendencia in pendencias %}
                    <tr>
                        {% for coluna in colunas_tipo %}
                        {% if coluna != 'modificado_por' %}
                        <td>
                            {% if coluna == 'tipo' %}
                            {{ pendencia.tipo_pendencia }}
                            {% elif coluna == 'banco' %}
                            {{ pendencia.banco or '—' }}
                            {% elif coluna == 'data' %}
                            {% if pendencia.data %}
                            {{ pendencia.data.strftime('%d/%m/%Y') }}
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                            {% elif coluna == 'data_abertura' %}
                            {{ pendencia.data_abertura.strftime('%d/%m/%Y %H:%M') }}
                            {% elif coluna == 'fornecedor_cliente' %}
                            {{ pendencia.fornecedor_cliente }}
                            {% elif coluna == 'valor' %}
                            R$ {{ "%.2f"|format(pendencia.valor) }}
                            {% elif coluna == 'codigo_lancamento' %}
                            {{ pendencia.codigo_lancamento or '—' }}
                            {% elif coluna == 'data_competencia' %}
                            {% if pendencia.data_competencia %}
                            {{ pendencia.data_competencia.strftime('%d/%m/%Y') }}
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                            {% elif coluna == 'data_baixa' %}
                            {% if pendencia.data_baixa %}
                            {{ pendencia.data_baixa.strftime('%d/%m/%Y') }}
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                            {% elif coluna == 'observacao' %}
                            {{ pendencia.observacao }}
                            {% elif coluna == 'tipo_credito_debito' %}
                            {% if pendencia.tipo_credito_debito %}
                            <span
                                class="badge {{ 'bg-success' if pendencia.tipo_credito_debito == 'CREDITO' else 'bg-danger' }}">
                                <i
                                    class="bi bi-{{ 'arrow-down-circle' if pendencia.tipo_credito_debito == 'CREDITO' else 'arrow-up-circle' }}"></i>
                                {{ 'Crédito' if pendencia.tipo_credito_debito == 'CREDITO' else 'Débito' }}
                            </span>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                            {% elif coluna == 'status' %}
                            {% if pendencia.status == 'Pendente Cliente' %}
                            <span class="badge bg-warning">
                                <i class="bi bi-clock"></i> Pendente Cliente
                            </span>
                            {% elif pendencia.status == 'PENDENTE OPERADOR UP' %}
                            <span class="badge bg-info">
                                <i class="bi bi-person-gear"></i> Operador UP
                            </span>
                            {% elif pendencia.status == 'PENDENTE SUPERVISOR' %}
                            <span class="badge bg-danger">
                                <i class="bi bi-person-check"></i> Supervisor
                            </span>
                            {% elif pendencia.status == 'Resolvida' %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i> Resolvida
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">{{ pendencia.status }}</span>
                            {% endif %}
                            {% endif %}
                        </td>
                        {% endif %}
                        {% endfor %}
                        <td>{% if pendencia.modificado_por == 'USUARIO' %}USUARIO{% else %}<span
                                class="text-muted">—</span>{% endif %}</td>
                        <td style="text-align: center; vertical-align: middle;">
                            {% if pendencia.nota_fiscal_arquivo %}
                            <a href="{{ url_for('main.baixar_anexo', pendencia_id=pendencia.id) }}"
                                class="btn btn-sm btn-outline-primary" title="Baixar anexo">
                                <i class="bi bi-download"></i> Anexo
                            </a>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td class="acoes-cell">
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                data-bs-target="#modalVerificar{{ pendencia.id }}" title="Verificar Pendência">
                                <i class="bi bi-eye"></i> Verificar
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center">Nenhuma pendência encontrada.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="mt-3 d-flex gap-2">
    <a href="{{ url_for('main.listar_pendencias', status='RESOLVIDA', empresa=empresa_filtro) }}"
        class="btn btn-outline-success">
        <i class="bi bi-check-circle"></i> Pendências Resolvidas
    </a>
    <a href="{{ url_for('main.relatorio_mensal', ref=current_month, empresa_id=empresa_id) }}"
        class="btn btn-outline-primary">
        <i class="bi bi-calendar-month"></i> Relatório Mensal
    </a>
</div>

{# MODAIS DE RESPOSTA DO CLIENTE - DEVEM FICAR DENTRO DO BLOCO CONTENT #}
{% for pendencia in pendencias %}
{% if session['usuario_tipo'] in ['cliente', 'cliente_supervisor'] and pendencia.status in ['PENDENTE CLIENTE',
'Pendente Cliente'] %}
<div class="modal fade" id="modalResponder{{ pendencia.id }}" tabindex="-1"
    aria-labelledby="modalResponderLabel{{ pendencia.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalResponderLabel{{ pendencia.id }}">
                    <i class="bi bi-chat-dots text-primary"></i> Responder Pendência - #{{ pendencia.id }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('main.ver_pendencia', token=pendencia.token_acesso) }}"
                enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="empresa" value="{{ empresa_filtro }}">
                <input type="hidden" name="tipo_pendencia" value="{{ tipo_filtro }}">
                <input type="hidden" name="busca" value="{{ request.args.get('busca', '') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="resposta{{ pendencia.id }}" class="form-label">Sua Resposta</label>
                        <textarea class="form-control" id="resposta{{ pendencia.id }}" name="resposta" rows="4" required
                            placeholder="Explique do que se trata esta pendência..."></textarea>
                        <div class="form-text">Por favor, explique do que se trata esta pendência.</div>
                    </div>
                    <div class="mb-3">
                        <label for="nota_fiscal_arquivo{{ pendencia.id }}" class="form-label">Anexar Documento (PDF,
                            JPG, PNG)</label>
                        <input type="file" class="form-control" id="nota_fiscal_arquivo{{ pendencia.id }}"
                            name="nota_fiscal_arquivo" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> Enviar Resposta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% if session['usuario_tipo'] in ['cliente', 'cliente_supervisor'] and 'PENDENTE COMPLEMENTO' in pendencia.status %}
<div class="modal fade" id="modalComplementar{{ pendencia.id }}" tabindex="-1"
    aria-labelledby="modalComplementarLabel{{ pendencia.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalComplementarLabel{{ pendencia.id }}">
                    <i class="bi bi-chat-dots text-warning"></i> Complementar Resposta - Pendência #{{ pendencia.id }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{{ url_for('main.ver_pendencia', token=pendencia.token_acesso) }}"
                enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="empresa" value="{{ empresa_filtro }}">
                <input type="hidden" name="tipo_pendencia" value="{{ tipo_filtro }}">
                <input type="hidden" name="busca" value="{{ request.args.get('busca', '') }}">
                <div class="modal-body">
                    <div class="alert alert-danger mb-3">
                        <strong>O operador solicitou complemento:</strong><br>
                        <span>{{ pendencia.motivo_recusa }}</span>
                    </div>

                    {% if respostas_anteriores.get(pendencia.id) %}
                    <div class="card mb-3" style="border-radius:12px;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-chat-left-quote me-1"></i>
                                Sua resposta anterior
                                <small class="text-muted">enviada em {{
                                    respostas_anteriores[pendencia.id].data_hora|datetime_local }}</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                onclick="usarComoBase({{ pendencia.id }})">
                                <i class="bi bi-arrow-clockwise"></i> Usar como base
                            </button>
                        </div>
                        <div class="card-body">
                            <pre class="mb-0"
                                style="white-space:pre-wrap; font-family:inherit; max-height: 150px; overflow-y: auto;">{{ respostas_anteriores[pendencia.id].valor_novo | e }}</pre>
                        </div>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="resposta{{ pendencia.id }}" class="form-label">Complemento da Resposta</label>
                        <textarea class="form-control" id="resposta{{ pendencia.id }}" name="resposta" rows="4" required
                            placeholder="Adicione as informações solicitadas pelo operador..."></textarea>
                        <div class="form-text">Adicione as informações ou documentos que estavam faltando.</div>
                    </div>
                    <div class="mb-3">
                        <label for="nota_fiscal_arquivo{{ pendencia.id }}" class="form-label">Anexar Documento (PDF,
                            JPG, PNG)</label>
                        <input type="file" class="form-control" id="nota_fiscal_arquivo{{ pendencia.id }}"
                            name="nota_fiscal_arquivo" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-send"></i> Enviar Complemento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

{# MODAL VERIFICAR PENDÊNCIA #}
{% for pendencia in pendencias %}
<div class="modal fade" id="modalVerificar{{ pendencia.id }}" tabindex="-1"
    aria-labelledby="modalVerificarLabel{{ pendencia.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalVerificarLabel{{ pendencia.id }}">
                    <i class="bi bi-file-earmark-text"></i> Verificar Pendência #{{ pendencia.id }} - {{
                    pendencia.empresa }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="row">
                    <!-- Informações da Pendência -->
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-header py-2 bg-light">
                                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informações da Pendência</h6>
                            </div>
                            <div class="card-body py-3">
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Empresa:</strong></div>
                                    <div class="col-md-8">{{ pendencia.empresa }}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Tipo:</strong></div>
                                    <div class="col-md-8">{{ pendencia.tipo_pendencia }}</div>
                                </div>
                                {% if pendencia.banco %}
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Banco:</strong></div>
                                    <div class="col-md-8">{{ pendencia.banco }}</div>
                                </div>
                                {% endif %}
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Data:</strong></div>
                                    <div class="col-md-8">
                                        {% if pendencia.data %}
                                        {{ pendencia.data.strftime('%d/%m/%Y') }}
                                        {% elif pendencia.data_abertura %}
                                        {{ pendencia.data_abertura.strftime('%d/%m/%Y %H:%M') }}
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Fornecedor/Cliente:</strong></div>
                                    <div class="col-md-8">{{ pendencia.fornecedor_cliente }}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Valor:</strong></div>
                                    <div class="col-md-8">
                                        <span class="text-primary fw-bold">R$ {{ "%.2f"|format(pendencia.valor)
                                            }}</span>
                                    </div>
                                </div>
                                {% if pendencia.codigo_lancamento %}
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Código Lançamento:</strong></div>
                                    <div class="col-md-8">{{ pendencia.codigo_lancamento }}</div>
                                </div>
                                {% endif %}
                                {% if pendencia.data_competencia %}
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Data Competência:</strong></div>
                                    <div class="col-md-8">{{ pendencia.data_competencia.strftime('%d/%m/%Y') }}</div>
                                </div>
                                {% endif %}
                                {% if pendencia.data_baixa %}
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Data Baixa:</strong></div>
                                    <div class="col-md-8">{{ pendencia.data_baixa.strftime('%d/%m/%Y') }}</div>
                                </div>
                                {% endif %}
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Status:</strong></div>
                                    <div class="col-md-8">
                                        {% if pendencia.status in ['Pendente Cliente', 'PENDENTE CLIENTE'] %}
                                        <span class="badge bg-warning">Pendente Cliente</span>
                                        {% elif pendencia.status == 'PENDENTE OPERADOR UP' %}
                                        <span class="badge bg-info">Operador UP</span>
                                        {% elif pendencia.status == 'PENDENTE SUPERVISOR' %}
                                        <span class="badge bg-danger">Supervisor</span>
                                        {% elif pendencia.status == 'Resolvida' or pendencia.status == 'RESOLVIDA' %}
                                        <span class="badge bg-success">Resolvida</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ pendencia.status }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Observação:</strong></div>
                                    <div class="col-md-8" style="word-wrap: break-word; white-space: pre-wrap;">{{
                                        pendencia.observacao or '—' }}</div>
                                </div>
                                {% if pendencia.nota_fiscal_arquivo %}
                                <div class="row mb-2">
                                    <div class="col-md-4"><strong>Anexo:</strong></div>
                                    <div class="col-md-8">
                                        <a href="{{ url_for('main.baixar_anexo', pendencia_id=pendencia.id) }}"
                                            class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download"></i> Baixar Anexo
                                        </a>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Motivo da Recusa (quando houver) -->
                    {% if pendencia.motivo_recusa or pendencia.motivo_recusa_supervisor %}
                    <div class="col-12">
                        <div class="card mb-3 border-warning">
                            <div class="card-header bg-warning text-dark py-2">
                                <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Motivo da Recusa</h6>
                            </div>
                            <div class="card-body py-3">
                                {% if pendencia.motivo_recusa_supervisor %}
                                <div class="alert alert-warning mb-2">
                                    <strong><i class="bi bi-person-check"></i> Recusado pelo Supervisor:</strong>
                                    <p class="mb-0 mt-2" style="word-wrap: break-word; white-space: pre-wrap;">{{
                                        pendencia.motivo_recusa_supervisor }}</p>
                                </div>
                                {% endif %}
                                {% if pendencia.motivo_recusa %}
                                <div class="alert alert-warning mb-0">
                                    <strong><i class="bi bi-person-gear"></i> Recusado pelo Operador:</strong>
                                    <p class="mb-0 mt-2" style="word-wrap: break-word; white-space: pre-wrap;">{{
                                        pendencia.motivo_recusa }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Primeira Resposta do Cliente (quando houver recusa) -->
                    {% if pendencia.motivo_recusa or pendencia.motivo_recusa_supervisor %}
                    {% if primeiras_respostas.get(pendencia.id) %}
                    <div class="col-12">
                        <div class="card mb-3 border-info">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0"><i class="bi bi-chat-left-quote"></i> Primeira Resposta do Cliente</h6>
                            </div>
                            <div class="card-body py-3" style="max-height: 200px; overflow-y: auto;">
                                <p class="mb-2" style="word-wrap: break-word; white-space: pre-wrap;">{{
                                    primeiras_respostas[pendencia.id].valor_novo }}</p>
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> Enviada em: {{
                                    primeiras_respostas[pendencia.id].data_hora.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% elif pendencia.resposta_cliente %}
                    <div class="col-12">
                        <div class="card mb-3 border-info">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0"><i class="bi bi-chat-left-quote"></i> Primeira Resposta do Cliente</h6>
                            </div>
                            <div class="card-body py-3" style="max-height: 200px; overflow-y: auto;">
                                <p class="mb-2" style="word-wrap: break-word; white-space: pre-wrap;">{{
                                    pendencia.resposta_cliente.split('--- COMPLEMENTO ---')[0].strip() }}</p>
                                {% if pendencia.data_resposta %}
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> Enviada em: {{
                                    pendencia.data_resposta.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}

                    <!-- Resposta do Cliente (resposta atual/completa) -->
                    {% if pendencia.resposta_cliente %}
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0"><i class="bi bi-chat-dots"></i> Resposta do Cliente</h6>
                            </div>
                            <div class="card-body py-3" style="max-height: 150px; overflow-y: auto;">
                                <p class="mb-2" style="word-wrap: break-word; white-space: pre-wrap;">{{
                                    pendencia.resposta_cliente }}</p>
                                {% if pendencia.data_resposta %}
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> Respondido em: {{
                                    pendencia.data_resposta.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Natureza de Operação -->
                    {% if pendencia.natureza_operacao %}
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0"><i class="bi bi-gear"></i> Natureza de Operação</h6>
                            </div>
                            <div class="card-body py-3" style="max-height: 150px; overflow-y: auto;">
                                <p class="mb-0" style="word-wrap: break-word; white-space: pre-wrap;">{{
                                    pendencia.natureza_operacao }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Fechar
                </button>

                {# Botões para ADMIN e SUPERVISOR #}
                {% if session['usuario_tipo'] in ['adm', 'supervisor'] %}
                <a href="{{ url_for('main.editar_pendencia', id=pendencia.id) }}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Editar
                </a>
                <a href="{{ url_for('main.resolver_pendencia', id=pendencia.id) }}" class="btn btn-success"
                    onclick="return confirm('Deseja marcar esta pendência como resolvida?')">
                    <i class="bi bi-check-circle"></i> Resolver
                </a>
                <form action="{{ url_for('main.deletar_pendencia', id=pendencia.id) }}" method="post"
                    style="display:inline;"
                    onsubmit="return confirm('Tem certeza que deseja excluir esta pendência?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="empresa" value="{{ empresa_filtro }}">
                    <input type="hidden" name="tipo_pendencia" value="{{ tipo_filtro }}">
                    <input type="hidden" name="busca" value="{{ request.args.get('busca', '') }}">
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="bi bi-trash"></i> Excluir
                    </button>
                </form>
                {% endif %}

                {# Botão para CLIENTE e CLIENTE SUPERVISOR #}
                {% if session['usuario_tipo'] in ['cliente', 'cliente_supervisor'] %}
                {% if pendencia.status in ['PENDENTE CLIENTE', 'Pendente Cliente'] %}
                <button type="button" class="btn btn-primary" onclick="abrirModalResponder({{ pendencia.id }})">
                    <i class="bi bi-chat-dots"></i> Responder Pendência
                </button>
                {% elif 'PENDENTE COMPLEMENTO' in pendencia.status %}
                <button type="button" class="btn btn-warning" onclick="abrirModalComplementar({{ pendencia.id }})">
                    <i class="bi bi-chat-dots"></i> Complementar Resposta
                </button>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}



<script>
    // Configuração de colunas por tipo de pendência
    const tipoColumns = {
        "Natureza Errada": ["tipo", "fornecedor_cliente", "valor", "codigo_lancamento", "data", "observacao", "status", "modificado_por"],
        "Competência Errada": ["tipo", "fornecedor_cliente", "valor", "codigo_lancamento", "data_competencia", "observacao", "status", "modificado_por"],
        "Data da Baixa Errada": ["tipo", "banco", "fornecedor_cliente", "valor", "codigo_lancamento", "data_baixa", "observacao", "status", "modificado_por"],
        "Cartão de Crédito Não Identificado": ["tipo", "banco", "data", "fornecedor_cliente", "valor", "observacao", "status", "modificado_por"],
        "Pagamento Não Identificado": ["tipo", "banco", "data", "fornecedor_cliente", "valor", "observacao", "status", "modificado_por"],
        "Recebimento Não Identificado": ["tipo", "banco", "data", "fornecedor_cliente", "valor", "observacao", "status", "modificado_por"],
        "Nota Fiscal Não Anexada": ["tipo", "banco", "data", "fornecedor_cliente", "valor", "observacao", "status", "modificado_por"],
        "Nota Fiscal Não Identificada": ["tipo", "banco", "fornecedor_cliente", "valor", "observacao", "status", "modificado_por"]
    };

    const columnLabels = {
        "tipo": "Tipo",
        "banco": "Banco",
        "data": "Data da Pendência",
        "data_abertura": "Data de Abertura",
        "fornecedor_cliente": "Fornecedor/Cliente",
        "valor": "Valor",
        "codigo_lancamento": "Código",
        "data_competencia": "Data Comp.",
        "data_baixa": "Data Baixa",
        "observacao": "Observação",
        "status": "Status",
        "modificado_por": "Modificado por"
    };

    // Função para atualizar as colunas da tabela
    function updateTableColumns(tipo) {
        const columns = tipoColumns[tipo] || ["tipo", "banco", "data", "fornecedor_cliente", "valor", "observacao", "status", "modificado_por"];
        const thead = document.querySelector('table thead tr');
        const tbody = document.querySelector('table tbody');

        // Atualizar cabeçalho
        let headerHTML = '';
        columns.forEach(col => {
            headerHTML += `<th>${columnLabels[col]}</th>`;
        });
        headerHTML += '<th>Anexo</th><th>Ações</th>';
        thead.innerHTML = headerHTML;

        // Recarregar a página para atualizar os dados
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('tipo_pendencia', tipo);
        window.location.href = currentUrl.toString();
    }

    // Event listener para mudança de tipo
    document.getElementById('tipo_pendencia').addEventListener('change', function () {
        updateTableColumns(this.value);
    });

    // Função para usar resposta anterior como base
    function usarComoBase(pendenciaId) {
        const modal = document.getElementById('modalComplementar' + pendenciaId);
        const respostaAnterior = modal.querySelector('pre').textContent;
        const textarea = document.getElementById('resposta' + pendenciaId);

        if (textarea) {
            textarea.value = respostaAnterior;
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
    }
</script>

{# MODAIS PARA OPERADOR RESPONDER PENDÊNCIA #}
{% for pendencia in pendencias %}
{% if session['usuario_tipo'] in ['adm', 'operador'] and pendencia.status == 'PENDENTE OPERADOR UP' %}
<div class="modal fade" id="modalResponder{{ pendencia.id }}" tabindex="-1"
    aria-labelledby="modalResponderLabel{{ pendencia.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('main.operador_natureza_operacao', id=pendencia.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-header">
                    <h5 class="modal-title" id="modalResponderLabel{{ pendencia.id }}">Responder Pendência #{{
                        pendencia.id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="natureza_operacao_{{ pendencia.id }}" class="form-label">Natureza de
                            Operação</label>
                        <textarea class="form-control" id="natureza_operacao_{{ pendencia.id }}"
                            name="natureza_operacao" rows="4" required></textarea>
                        <div class="form-text">Descreva qual operação o cliente informou no sistema Kamino ou a natureza
                            da transação.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-arrow-up-circle"></i> ENVIAR AO SUPERVISOR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}
</tbody>
</table>
</div>
</div>
</div>

<style>
    .filter-icon {
        cursor: pointer;
        color: #adb5bd;
        margin-left: 5px;
        opacity: 0.5;
        transition: 0.2s;
    }

    .filter-icon:hover,
    .filter-icon.active {
        color: #0e3b6f;
        opacity: 1;
    }

    .filter-dropdown {
        position: absolute;
        z-index: 1050;
        background: white;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 220px;
    }

    .filter-search {
        width: 100%;
        padding: 6px;
        margin-bottom: 8px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .filter-options {
        max-height: 250px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .filter-option {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        padding: 2px 0;
    }

    .filter-option:hover {
        background: #f8f9fa;
    }

    .filter-actions {
        margin-top: 10px;
        padding-top: 8px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    th {
        position: relative;
    }

    /* Anchor for absolute dropdown */
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        initExcelFilters();
    });

    function initExcelFilters() {
        const table = document.querySelector('.table');
        if (!table) return;

        // Headers excluding actions/anexo
        const headers = Array.from(table.querySelectorAll('thead th'));

        headers.forEach((header, colIndex) => {
            const text = header.innerText.trim();
            if (['Ações', 'Anexo', 'Modificado por', ''].includes(text)) return;

            // Add Icon
            const icon = document.createElement('i');
            icon.className = 'bi bi-funnel-fill filter-icon';
            icon.onclick = (e) => {
                e.stopPropagation();
                toggleFilterDropdown(colIndex, header, icon);
            };
            header.appendChild(icon);
        });

        // Close on click outside
        document.addEventListener('click', () => closeAllDropdowns());
    }

    function toggleFilterDropdown(colIndex, header, icon) {
        const existing = document.getElementById('filter-dropdown-' + colIndex);
        if (existing) {
            existing.remove();
            return;
        }

        closeAllDropdowns();

        // Create Dropdown
        const dropdown = document.createElement('div');
        dropdown.id = 'filter-dropdown-' + colIndex;
        dropdown.className = 'filter-dropdown';

        // Position (handling table overflow)
        // For simplicity, we append to body or header. Header is safer if relative.
        // Let's append to header. 
        // Header needs position: relative (added in CSS).
        dropdown.style.top = '100%';
        dropdown.style.left = '0';

        // 1. Get Unique Values
        const rows = Array.from(document.querySelectorAll('tbody tr'));
        let values = new Set();
        rows.forEach(row => {
            if (row.cells[colIndex]) {
                let val = row.cells[colIndex].innerText.trim();
                if (val) values.add(val);
            }
        });
        values = Array.from(values).sort();

        // 2. Search Input
        const search = document.createElement('input');
        search.className = 'filter-search';
        search.placeholder = 'Buscar...';
        search.onclick = (e) => e.stopPropagation();
        search.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            optionsContainer.querySelectorAll('.filter-option').forEach(opt => {
                opt.style.display = opt.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
            });
        };
        dropdown.appendChild(search);

        // 3. Options
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'filter-options';

        values.forEach(val => {
            const label = document.createElement('label');
            label.className = 'filter-option';
            label.onclick = (e) => e.stopPropagation();

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = val;
            cb.checked = true; // Default selected? Or check active filters?

            // Check if currently filtered
            if (activeFilters[colIndex]) {
                cb.checked = activeFilters[colIndex].includes(val);
            }

            label.appendChild(cb);
            label.appendChild(document.createTextNode(val));
            optionsContainer.appendChild(label);
        });
        dropdown.appendChild(optionsContainer);

        // 4. Actions
        const actions = document.createElement('div');
        actions.className = 'filter-actions';

        const btnClear = document.createElement('button');
        btnClear.className = 'btn btn-sm btn-link text-danger p-0';
        btnClear.innerText = 'Limpar';
        btnClear.onclick = (e) => {
            e.stopPropagation();
            delete activeFilters[colIndex];
            header.querySelector('.filter-icon').classList.remove('active');
            applyFilters();
            closeAllDropdowns();
        };

        const btnApply = document.createElement('button');
        btnApply.className = 'btn btn-sm btn-primary py-0 px-2';
        btnApply.innerText = 'OK';
        btnApply.onclick = (e) => {
            e.stopPropagation();
            const selected = Array.from(optionsContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            activeFilters[colIndex] = selected;
            header.querySelector('.filter-icon').classList.add('active');
            applyFilters();
            closeAllDropdowns();
        };

        actions.appendChild(btnClear);
        actions.appendChild(btnApply);
        dropdown.appendChild(actions);

        header.appendChild(dropdown);
    }

    const activeFilters = {};

    function closeAllDropdowns() {
        document.querySelectorAll('.filter-dropdown').forEach(d => d.remove());
    }

    function applyFilters() {
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            let show = true;
            for (const [colIndex, validValues] of Object.entries(activeFilters)) {
                const cell = row.cells[colIndex];
                if (!cell) continue;
                const val = cell.innerText.trim();
                if (!validValues.includes(val)) {
                    show = false;
                    break;
                }
            }
            row.style.display = show ? '' : 'none';
        });
    }

    // Função para transição segura entre modais (evita bug de backdrop travado)
    function abrirModalComplementar(pendenciaId) {
        const modalVerificarEl = document.getElementById('modalVerificar' + pendenciaId);
        const modalCompEl = document.getElementById('modalComplementar' + pendenciaId);

        if (!modalCompEl) {
            console.error('Modal complementar não encontrado no DOM para ID:', pendenciaId);
            // Tenta abrir o modalResponder se for o caso, ou apenas alerta
            return;
        }

        const modalVerificar = bootstrap.Modal.getOrCreateInstance(modalVerificarEl);
        const modalComp = bootstrap.Modal.getOrCreateInstance(modalCompEl);

        if (modalVerificarEl.classList.contains('show')) {
            modalVerificarEl.addEventListener('hidden.bs.modal', function onHidden() {
                modalComp.show();
                modalVerificarEl.removeEventListener('hidden.bs.modal', onHidden);
            }, { once: true });
            modalVerificar.hide();
        } else {
            modalComp.show();
        }
    }

    // Função para transição segura para o modal de resposta
    function abrirModalResponder(pendenciaId) {
        const modalVerificarEl = document.getElementById('modalVerificar' + pendenciaId);
        const modalRespEl = document.getElementById('modalResponder' + pendenciaId);

        if (!modalRespEl) return;

        const modalVerificar = bootstrap.Modal.getOrCreateInstance(modalVerificarEl);
        const modalResp = bootstrap.Modal.getOrCreateInstance(modalRespEl);

        if (modalVerificarEl.classList.contains('show')) {
            modalVerificarEl.addEventListener('hidden.bs.modal', function onHidden() {
                modalResp.show();
                modalVerificarEl.removeEventListener('hidden.bs.modal', onHidden);
            }, { once: true });
            modalVerificar.hide();
        } else {
            modalResp.show();
        }
    }

    // Limpeza global de backdrops órfãos ao fechar qualquer modal
    document.addEventListener('hidden.bs.modal', function () {
        setTimeout(() => {
            if (document.querySelectorAll('.modal.show').length === 0) {
                document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                document.body.classList.remove('modal-open');
                document.body.style.paddingRight = '';
            }
        }, 300); // Atraso maior para garantir transições
    });
</script>

{% endblock %}